<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Tool for helping with camera alignment</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
    <style>
        html {
            background-color: #000;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        body {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #container {
            box-sizing: border-box;
            display: inline-block;
            position: absolute;
            height: 100%;
            width: 100%;
            padding: 0;
            margin: 0;
        }

        .buttons {
            background-color: #333;
            position: absolute;
            z-index: 100;
        }

        .button {
            background-color: #333;
            color: darkorange;
            border: none;
            height: 24px;
            padding: 1px 6px;
        }

        #video {
            position: absolute;
        }

        #canvas {
            position: absolute;
            z-index: 200;
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'liga';
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="buttons">
            <button class="button" onclick="selectBackCamera()">
                <span class="material-icons">video_camera_back</span>
            </button><br/>
            <button class="button" onclick="selectFrontCamera()">
                <span class="material-icons">video_camera_front</span>
            </button><br />
            <a class="button" href="https://rikard-engstrom.github.io/">
                <span class="material-icons">close</span>
            </a>
        </div>
        <video id="video" autoplay="true"></video>
        <canvas id="canvas"></canvas>
    </div>
    <script>
        let width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        let height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

        let constraints = {
            audio: false,
            video: {
                facingMode: "environment",
                width: { ideal: width },
                height: { ideal: height } 
            }
        };

        let video = document.querySelector("#video");
        video.addEventListener('resize', alignElements);

        let canvas = document.querySelector("#canvas");

        function hasGetUserMedia() {
            return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        }

        function selectFrontCamera() {
            constraints.video.facingMode = "user"
            showMedia();
        }

        function selectBackCamera() {
            constraints.video.facingMode = "environment"
            showMedia();
        }

        function showMedia(){
            if (hasGetUserMedia()) {
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function (stream) {
                        video.srcObject = stream;
                    })
                    .catch(function (error) {
                        // TODO: Show some error.        
                    });
            } else {
                // TODO: Show some error.
            }
        }

        function alignElements() {
            console.log('alignElements');
            let videoWidth = video.offsetWidth;
            let videoHeight = video.offsetHeight;
            video.style.left = Math.round((width / 2) - (videoWidth / 2)) + "px";
            video.style.top = Math.round((height / 2) - (videoHeight / 2)) + "px";

            canvas.width = videoWidth;
            canvas.height = videoHeight;
            canvas.style.left = video.style.left;
            canvas.style.top = video.style.top;

            drawAlignmentGrid();
        }

        function drawAlignmentGrid() {
            let videoWidth = video.offsetWidth;
            let videoHeight = video.offsetHeight;

            var ctx = canvas.getContext("2d");
            ctx.strokeStyle = "#FFF"

            // verticle center
            ctx.moveTo(videoWidth / 2, 0);
            ctx.lineTo(videoWidth / 2, videoHeight);

            // horizontal center
            ctx.moveTo(0, videoHeight / 2);
            ctx.lineTo(videoWidth, videoHeight/2);

            // outerbox
            let outerBoxWidth = videoWidth * 0.75;
            let outerBoxHeight = videoHeight * 0.75;
            let outerTop = videoHeight * 0.125;
            let outerLeft = videoWidth * 0.125;
            ctx.rect(outerLeft, outerTop, outerBoxWidth, outerBoxHeight);

            ctx.stroke();
        }

        showMedia();
        alignElements();        
    </script>
</body>

</html>